const path = require('path');
const os = require('os');

const ScratchOrg = require(LoadScratchOrgApi());
const forceUtils = require('../lib/forceUtils.js');
const forge = require('node-forge');
const certs = require('../lib/certs.js');
const fs = require('fs');

function LoadScratchOrgApi() {

  let pluginPath;
  var isWin = /^win/.test(process.platform);

  if (isWin) {
    pluginPath = path.join(os.homedir(), '/AppData/Local/heroku/plugins/node_modules/salesforce-alm/lib/scratchOrgApi');
  } else {
    pluginPath = path.join(os.homedir(), '.local/share/heroku/plugins/node_modules/salesforce-alm/lib/scratchOrgApi')
  }

  return pluginPath;
}

(function () {
  'use strict';

  module.exports = {
    topic: 'connectedapp',
    command: 'create',
    description: 'Create a connected app in your org',
    help: 'help text for wadewegner:connectedapp:create',
    flags: [{
        name: 'targetusername',
        char: 'u',
        description: 'username or alias for the target org',
        hasValue: true,
        required: true
      },
      {
        name: 'name',
        char: 'n',
        description: 'connected app name',
        hasValue: true,
        required: true
      },
      {
        name: 'certificate',
        char: 'r',
        description: 'create and register a certificate',
        required: false,
        hasValue: false,
        type: 'flag'
      },
      {
        name: 'callbackurl',
        char: 'c',
        description: 'callbackUrl (default is "sfdx://success")',        
        hasValue: true,
        required: false
      },
      {
        name: 'description',
        char: 'd',
        description: 'connected app description',
        hasValue: true,
        required: false
      },
      {
        // Basic,Api,Web,Full,Chatter,CustomApplications,RefreshToken,OpenID,CustomPermissions,Wave,Eclair
        name: 'scopes',
        char: 's',
        description: 'scopes separated by commas (defaut: Basic, Api, Web, RefreshToken; valid: Basic, Api, Web, Full, Chatter, CustomApplications, RefreshToken, OpenID, CustomPermissions, Wave, Eclair)',
        hasValue: true,
        required: false
      }
    ],
    run(context) {

      const targetUsername = context.flags.targetusername;
      const connectedAppName = context.flags.name;
      let callbackurl = context.flags.callbackurl;
      if (!callbackurl) {
        callbackurl = 'sfdx://success';
      }
      const createCerts = context.flags.certificate;
      let appDescription = context.flags.description;
      if (!appDescription) {
        appDescription = 'generated by wadewegner:connectedapp:create';
      }
      const origScopes = context.flags.scopes;
      let appScopes = [];
      if (origScopes) {
        appScopes = origScopes.split(',');
      } else {
        appScopes = ['Basic', 'Api', 'Web', 'RefreshToken'];
      }

      const generatedConsumerSecret = forceUtils.getConsumerSecret();

      forceUtils.getUsername(targetUsername, (username) => {

        const pki = forge.pki;
        const keys = pki.rsa.generateKeyPair(2048);
        const privKey = forge.pki.privateKeyToPem(keys.privateKey);

        certs.getSelfSignedCertificate(pki, keys, (cert) => {

          let pubKey;

          if (createCerts) {
            pubKey = pki.certificateToPem(cert);

            fs.writeFile('server.key', privKey, (err) => {
              if (err) {
                return console.log(err); // eslint-disable-line no-console
              }
            });

            fs.writeFile('server.crt', pubKey, (err) => {
              if (err) {
                return console.log(err); // eslint-disable-line no-console
              }
            });
          }

          ScratchOrg.create(username).then((org) => {
            org.force._getConnection(org, org.config).then((conn) => {

              let metadata;

              if (createCerts) {
                metadata = [{
                  contactEmail: username,
                  description: appDescription,
                  fullName: connectedAppName,
                  label: connectedAppName,
                  oauthConfig: {
                    callbackUrl: callbackurl,
                    consumerSecret: generatedConsumerSecret,
                    certificate: pubKey,
                    scopes: appScopes
                  }
                }];
              } else {
                metadata = [{
                  contactEmail: username,
                  description: appDescription,
                  fullName: connectedAppName,
                  label: connectedAppName,
                  oauthConfig: {
                    callbackUrl: callbackurl,
                    consumerSecret: generatedConsumerSecret,
                    scopes: appScopes
                  }
                }];
              }

              conn.metadata.create('ConnectedApp', metadata, (createErr, results) => {
                if (results.success) {
                  conn.metadata.read('ConnectedApp', connectedAppName, (readErr, metadataResult) => {
                    console.log(metadataResult); // eslint-disable-line no-console
                  });
                } else {
                  console.log(results); // eslint-disable-line no-console
                }
              });
            });
          });
        });
      });
    }
  };
}());